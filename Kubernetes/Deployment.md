# Deployment
Deployment - это инструмент для запуска приложений без состояния в k8s. Они добавляют следующую функциональность по сравнение с запуском подов напрямую:
- Автоматическое восстановление
- Масштабирование
- Rollout
- Rollback

Deployment управляет набором подов. Если под завершает свою работу с ошибкой, контроллер управлявшего им Deployment заменяет его новым. Если увеличится требование по количеству запущенных реплик, то Deployment запустит дополнительные поды. При обновлении приложения Deployment удаляет старые поды и заменяет их новыми.

При описании Deployment в YAML указываются шаблон пода и необходимое количество реплик:
``` yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploymentname
spec:
  replicas: 4 # Количество реплик
  ...
  template: # Шаблон пода
    spec:
      containers:
      - name: containername
        image: imagename
        ports:
        - containerPort: 8080
```

#### Autoscaler
В k8s есть набор инструментов для автоматического масштабирования (autoscalers):
- The Horizontal Pod Autoscaler. Добавляет или удаляет поды при необходимости
- The Vertical Pod Autoscaler. Увеличивает выделенные подам ресурсы (CPU, память)
- The Cluster Autoscaler. Добавляет или удаляет ноды в кластере, чтобы их было достаточно для запуска всех подов

#### Rolling update
Deployments используются для обновления приложений без простоя. Для этого приложения должны обладать:
1) Слабой связностью через чётко определённый задокументированный интерфейс
2) Обратной и прямой совместимостью. Обновления сервиса не должны зависеть от версий клиента, которые его используют

Каждый микросервис собирается в контейнер, и помещается в под. Подами управляет Deployment, который определяет следующие параметры приложения:
- Количество реплик подов
- Образ для создания контейнера
- Сетевые порты
- Как проводить обновления

Чтобы запустить приложение, необходимо отправить YAML файл с описанием Deployment в API server, после чего контроллер ReplicaSet убеждается, что необходимое число подов запланировано на запуск. Контроллер также наблюдает за кластером, убеждаясь, что *observed state* совпадает с *desired state*.

Чтобы обновить приложение, необходимо обновить тот же самый YAML файл с описанием Deployment, изменив шаблон пода, и повторно отправить его в API server. Это действие обновит существующий объект Deployment новым *desired state*, в котором будет указано то же самое количество подов, но с более новой версией приложения.

Теперь *desired state* не совпадает с *observed state*. Для согласования контроллер Deployment создаёт новый ReplicaSet, в котором определяется то же самое количество подов, но с другой версией приложения. Теперь в кластере два объекта ReplicaSet: изначальный со старой версией приложения и новый. Контроллер Deployment постепенно увеличивает количество подов в новом ReplicaSet, и уменьшает в старом. После завершения обновления, старый ReplicaSet сохраняется в системе, чтобы была возможность откатить релиз.